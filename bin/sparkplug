#!/usr/bin/env python

import simplejson as json
import sys
from argparse import ArgumentParser
import xmltodict
from glob import glob

from sparkplug import SparkPlug
from sparkplug.parsers import xml

def getArgs():

    parser = ArgumentParser()
    
    parser.add_argument("--payload",
                        required=True,
                        type=str,
                        default=None)
    
    parser.add_argument("--url",
                        required=False,
                        type=str,
                        default="http://localhost:8161/api/message/ImportQueue?type=queue")
    
    parser.add_argument("--username",
                        required=False,
                        type=str)
    
    parser.add_argument("--password",
                        required=False,
                        type=str)
    
    parser.add_argument("--isDryrun",
                        required=False,
                        default=False,
                        action='store_true')
    
    parser.add_argument("--compress",
                        required=False,
                        default=False,
                        action='store_true')

    parser.add_argument("--skipValidation",
                        required=False,
                        default=False,
                        action='store_true')
    
    parser.add_argument("--saveAsXML",
                        default=None,
                        required=False,
                        type=str)
    
    parser.add_argument("--saveAsJSON",
                        default=None,
                        required=False,
                        type=str)
    
    args = parser.parse_args()

    return args

def loadMessage(fileName):

    try:

        f = open(fileName, 'r')
        if fileName.endswith("json"):
            message = json.load(f)
        elif fileName.endswith("xml"):
            message = xml.load(f)
            #print(json.dumps(message))
        else:
            raise Exception("Unknown file format: {}".format(fileName))
        f.close()
        
    except Exception as e:
        raise Exception("Provided object in file {} ".format(fileName) +
                        "could not be parsed, reason: {}".format(str(e)))
    
        
    return message

def resolveFileNames(path):

    fileNames = glob(path)

    if len(fileNames) == 0:
        raise Exception("Could not glob anything with: {}".format(path))

    return fileNames


def main():
    
    args = getArgs()
    
    fileNames = resolveFileNames(args.payload)

    print(fileNames)
    
    
    for fileName in fileNames:
        
        message = loadMessage(fileName)
        
        plug = SparkPlug(url=args.url,
                         username=args.username,
                         password=args.password)
        
        response = plug.post(message,
                             skipValidation=args.skipValidation,
                             isDryrun=args.isDryrun, 
                             compress=args.compress)
        
        if args.saveAsXML is not None:
            print("Saving as XML to: {}".format(args.saveAsXML))
            f = open(args.saveAsXML, 'w')
            f.write(dicttoxml(message))
            f.close()

        if args.saveAsJSON is not None:
            print("Saving as JSON to: {}".format(args.saveAsJSON))
            f = open(args.saveAsJSON, 'w')
            f.write(json.dumps(message, indent=2))
            f.close()
            
            
        print("{}: {}".format(fileName, response))


if __name__ == "__main__":
    main()
